<template>
  <d2-container type="card">
    <template slot="header">虚拟机</template>
    <div class="handle-head">
      <div class="filter">
        <el-select v-model="table.getParams.datacenter__name" filterable class="d2-mr-5" size="mini"  placeholder="请选择数据中心"  @change="getVirtualhostData">
          <el-option
            v-for="item in TreeData"
            :key="item.value"
            :label="item.label"
            :value="item.value"
            v-show="table.data.length>0"
          >
          </el-option>
        </el-select>
      </div>
      <div class="search" >
        <el-input v-model="table.getParams.search" placeholder="请输入虚拟机名称"  class="handle-input mr5" size="mini"  ></el-input>
        <el-button icon="el-icon-search"  size="mini" circle @click="getVirtualhostData" style="margin-left: 10px"></el-button>
        <el-button size="mini"  icon="el-icon-refresh" circle @click="refreshClick"></el-button>
      </div>
      <div class="download">
        <el-button type="primary" size="mini" round @click="exportExcel">
          <d2-icon name="download"/>导出Excel
        </el-button>
      </div>
    </div>
    <el-table
      :data="table.data"
      style="width: 100%"
      @sort-change="changeTableSort"
      v-if="table.data.length>0"
    >
      <el-table-column prop="name" label="虚拟机名" width="200"></el-table-column>
      <el-table-column prop="datacenter" label="数据中心" width="200"></el-table-column>
      <el-table-column prop="host" label="宿主机" width="150"></el-table-column>
      <el-table-column prop="ip" label="IP" width="150"></el-table-column>
      <el-table-column prop="powerState" label="电源状态" width="110">
        <template slot-scope="scope">
          <div slot="referehce" class="name-wapper" style="text-align: left">
            <el-tag style="color: #000" :color="POWER_STATE[scope.row.powerState].color">
              {{POWER_STATE[scope.row.powerState].type}}
            </el-tag>
          </div>
        </template>
      </el-table-column>
      <el-table-column prop="cpunums" label="CPU数" width="110"></el-table-column>
      <el-table-column prop="memtotal" label="内存" width="110" sortable="custom"></el-table-column>
      <el-table-column prop="os" label="系统" width="250"></el-table-column>
      <el-table-column prop="cpuusage" label="CPU用量" width="130"></el-table-column>
      <el-table-column prop="memusage" label="内存用量" width="130"></el-table-column>
      <el-table-column prop="store_usage" label="存储用量" width="130" sortable="custom"></el-table-column>
      <el-table-column prop="status" label="状态" width="130">
        <template slot-scope="scope">
          <div slot="referehce" class="name-wapper" style="text-align: left">
            <el-tag style="color: #000" :color="VIRTUAL_STATUS[scope.row.status].color">
              {{VIRTUAL_STATUS[scope.row.status].type}}
            </el-tag>
          </div>
        </template>
      </el-table-column>
    </el-table>
    <div class="d2-crud-footer">
      <div class="d2-crud-pagination">
        <el-pagination
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
          :current-page.sync="table.getParams.page"
          :page-sizes="[10, 20, 50,100,500]"
          :page-size="table.getParams.page_size"
          layout="total, sizes, prev, pager, next, jumper"
          :total="table.total">
        </el-pagination>
      </div>
    </div>
  </d2-container>
</template>

<script>
import { getvirtualhost,gettreedata } from '@api/vms'
import Vue from 'vue'
import pluginExport from '@d2-projects/vue-table-export'
Vue.use(pluginExport)
export default {
name: 'virtualhost',
  created () {
    this.getVirtualhostData();
    this.getTreeData();
  },
  data() {
    return {
      TreeData:[],
      table: {
        columns:[
          //{label:'ID',prop:'id',sort:"custom",},
          {label:'虚拟机名',prop:'name',},
          {label:'数据中心',prop:'datacenter',},
          {label:'宿主机',prop:'host',},
          {label: 'IP',prop: 'ip',},
          {label:'电源状态',prop:'powerState',},
          {label:'CPU核数',prop:'cpunums',},
          {label:'内存',prop:'memtotal',},
          {label:'系统',prop:'os',},
          {label:'CPU用量',prop:'cpuusage',},
          {label:'内存用量',prop:'memusage',},
          {label:'存储用量',prop:'store_usage',},
          {label: '状态',prop: 'status',}
        ],
        data : [],
        size: 'mini',
        stripe: 'true',
        fit:'true',
        getParams:{
          page:1,
          page_size:10,
          search:'',
          ordering:'',
          datacenter__name: ''
        },
        total:0,

      },
      VIRTUAL_STATUS: {
        'green' :{'color':'#67C23A','type':'正常'},
        'yellow' :{'color':'#E6A23C','type':'异常'}
      },
      POWER_STATE: {
        'poweredOn':{'color':'#67C23A',type:'已开机'},
        'poweredOff':{'color':'#E6A23C',type:"已关机"}
      }
    }
  },
  methods: {
    //导出excel
    exportExcel() {
      this.$export.excel({
        columns: this.table.columns,
        data: this.table.data,
        title: '虚拟机列表'
      }).then(()=>{
        this.$message('表格导出成功')
      })
    },
    //获取所以虚拟机信息
    getVirtualhostData() {
      getvirtualhost (this.table.getParams).then(res=>{
        console.log(this.table.getParams)
        this.table.data = res.results;
        this.table.total = res.count;
        console.log(this.table.data)
      }).catch(function (error){
        console.log(error)
      })
    },
    getTreeData() {
      gettreedata().then(res=>{
        console.log(res)
        this.TreeData = res
      })
    },
    refreshClick(){
      this.table.getParams = {
        page:1,
        page_size:10,
        search:'',
        ordering:'',
        datacenter__name: ''
      };
      this.getVirtualhostData();
    },
    handleCurrentChange(page){
      this.table.getParams.page=page
      this.getVirtualhostData();
    },
    handleSizeChange(size){
      this.table.getParams.page_size = size
      this.getVirtualhostData();
    },
    //对指定字段排序
    changeTableSort (column) {
      console.log(column);
      //  获取字段名和排序类型
      var fieldName = column.prop;
      var sortingType = column.order;
      //按照降序排序
      if (sortingType === "descending") {
        this.table.getParams.ordering = '-' + fieldName
        this.getVirtualhostData();
        // this.table.data = this.table.data.sort((a, b) => b[fieldName] - a[fieldName]);
      }
      //按照升序排序
      else {
        this.table.getParams.ordering = fieldName
        this.getVirtualhostData();
        //this.table.data = this.table.data.sort((a, b) => a[fieldName] - b[fieldName]);

      }
    },
  }
}
</script>

<style scoped>
.el-row {
  margin-bottom: 20px;
&:last-child {
   margin-bottom: 0;
 }
}
.el-col {
  border-radius: 4px;
}
.handle-head {
  padding-bottom: 5px;
}
.filter {
  float: left;
  margin-right: 10px;
}
.search {
  float: left;
}
.handle-input {
  width: 300px;
  display: inline-block;
}
.download {
  margin-top: 5px;
  margin-bottom: 5px;
  margin-inside: 5px;
  float: right;
}

</style>
